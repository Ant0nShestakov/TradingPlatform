@using AVS.Models.UserModels

@model Message;
@{
    ViewData["Title"] = "Диалог";
}

<div class="personal_info">
    <div class="personal_info_container">
        <img class="userLogo" src="https://demotivation.ru/wp-content/uploads/2020/09/vindiesel156919.jpg" />
        <p><span>@ViewBag.Sender.Name</span> <span>@ViewBag.Sender.SecondName</span></p>
    </div>
    <hr>
    <div class="pesronal_settings">
        <a asp-controller="PersonalAccount" asp-action="Index">Мои сообщения</a>
        <a asp-controller="PersonalAccount" asp-action="MyAdvertisements">Мои объявления</a>
        <a asp-controller="Advertisement" asp-action="CreateAdvertisement">Создать объявление</a>
        <a asp-controller="PersonalAccount" asp-action="Logout">Выйти</a>
    </div>
</div>
<div class="chats_container">
    <div class="chat_discription_container">
        <a href="#">
            <div class="chat_container">
                <div class="userSenderLogo">
                    <img src="https://demotivation.ru/wp-content/uploads/2020/09/vindiesel156919.jpg" />
                </div>
                <div class="chat_discription">
                    <a asp-controller="Advertisement" asp-action="ShowAdvertisement" asp-route-id="@ViewBag.Advertisement.ID">
                        @ViewBag.Advertisement.Title
                    </a>
                    <a asp-controller="Advertisement" asp-action="ShowAdvertisement" asp-route-id="@ViewBag.Advertisement.ID">
                        @ViewBag.Advertisement.Description
                    </a>
                </div>
            </div>
        </a>
    </div>
    <content>
        <div class="dialog_container">
            <div class="row">
                <div>
                    <div class="card">

                        <div class="card-body chat-care">
                            <ul class="chat">
                                @foreach (Message message in ViewBag.Messages)
                                {
                                    @if (message.SenderUserId == ViewBag.Sender.Id)
                                    {
                                        <li class="admin clearfix">
                                            <div class="chat-body clearfix">
                                                <div class="header clearfix">
                                                    <strong class="primary-font">@message.SenderUser.Name</strong> <small class="right text-muted">
                                                        <span class="glyphicon glyphicon-time"></span>@message.CreatedAt?.ToString("dd.MM.yy HH:mm")
                                                    </small>
                                                </div>
                                                <p>
                                                    @message.Content
                                                </p>
                                            </div>
                                        </li>
                                    }
                                    else
                                    {
                                        <li class="agent clearfix">
                                            <div class="chat-body clearfix">
                                                <div class="header clearfix">
                                                    <small class="left text-muted"><span class="glyphicon glyphicon-time"></span>@message.CreatedAt?.ToString("dd.MM.yy HH:mm")</small>
                                                    <strong class="right primary-font">@message.SenderUser.Name</strong>
                                                </div>
                                                <p>
                                                    @message.Content
                                                </p>
                                            </div>
                                        </li>
                                    }
                                }

                            </ul>
                        </div>
                        <div class="card-footer">
                            @Html.AntiForgeryToken()
                            <form asp-controller="Messages" asp-action="PostMessage" method="post">
                                <input type="hidden" name="advertisementId" value="@ViewBag.Advertisement.ID" />
                                <input type="hidden" name="index" value="@ViewBag.Index" />
                                <div class="input-group">
                                    <textarea asp-for="Content"
                                              id="btn-input"
                                              class="form-control input-sm"
                                              placeholder="Type your message here..."
                                              rows="1"
                                              style="overflow: hidden; resize: none;"></textarea>
                                    <span class="input-group-btn">
                                        <button type="submit" class="btn btn-primary" id="btn-chat">Send</button>
                                    </span>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </content>
</div>

@section Scripts {
    <!-- Добавляем JavaScript для автоувеличения высоты textarea -->
    <script>
        function autoResizeTextarea() {
            const textarea = document.getElementById("btn-input");
            const maxHeight = 150; // Ограничение по максимальной высоте (в пикселях)

            textarea.addEventListener("input", function () {
                // Сбрасываем высоту для пересчета
                this.style.height = "auto";

                const newHeight = this.scrollHeight;

                // Если новая высота превышает максимальный лимит, устанавливаем максимальный предел
                if (newHeight > maxHeight) {
                    this.style.height = maxHeight + "px"; // Ограничиваем высоту
                    this.style.overflowY = "scroll"; // Включаем вертикальную прокрутку
                } else {
                    this.style.height = newHeight + "px"; // Иначе устанавливаем высоту по scrollHeight
                    this.style.overflowY = "hidden"; // Скрываем прокрутку, если она не нужна
                }
            });
        }

        // Вызов функции для активации авто-размера
        autoResizeTextarea();
    </script>
}
